<head>
    <script type="text/javascript">
        const examplePageLinks = "i will [[Link]] to another [[Few Links]] shortly"
        // Descriptions of blocks that begin and end with double symbols, like [[, **, __
        const pairs = [
            { type: "page link", start: "[", end: "]" },
        ];
        const exampleAST = { type: "plain", children: [{ type: "page link", start: 0, end: 10, children: [{ type: "text", start: 2, end: 5 }] }] };

        const pairStartTable = pairs.reduce((acc, val) => { acc[val.start + val.start] = val; return acc }, {});
        const pairEndTable = pairs.reduce((acc, val) => { acc[val.end + val.end] = val; return acc }, {});
        console.log(pairEndTable);

        // regex for blocks of chars that are under no circumstances broken up.
        const regexGuaranteedPlainText = new RegExp(`^[^${pairs.map(pair => `\\${pair.start}\\${pair.end}`).join()}]+`);
        console.log(regexGuaranteedPlainText);
        let textLeft = examplePageLinks;
        const stime = performance.now();
        const tree = { type: "plain", children: [], start: 0, end: textLeft.length };
        const stack = [tree];
        let i = 0;
        while (textLeft.length > 0) {
            const wordMatch = textLeft.match(regexGuaranteedPlainText);
            if (wordMatch) {
                stack[stack.length - 1].children.push(wordMatch[0]);
                i += wordMatch[0].length;
                textLeft = textLeft.substring(wordMatch[0].length);
            } else {
                const nextTwoChars = textLeft.substring(0, 2);
                const pairStart = pairStartTable[nextTwoChars];
                if (pairStart !== undefined) {
                    const newNode = { type: pairStart.type, start: i, children: [] };
                    stack[stack.length - 1].children.push(newNode);
                    stack.push(newNode);
                } else {
                    const pairEnd = pairEndTable[nextTwoChars];
                    if (pairEnd !== undefined) {
                        stack[stack.length - 1].end = i + 3;
                        stack.pop();
                    }
                }
                textLeft = textLeft.substring(2);
                i += 2;
            }
        }
        console.log(performance.now() - stime);
        console.log(tree);
    </script>
</head>